# 行波故障测距 Demo（基于 .all 录波文件）

## 仅供个人练习，目前只有 Java 实现

本 Demo 目前**不再依赖数据库 / SQLite**，而是直接以录波装置导出的 `.all` 文件为数据源，
在 Java 中完成：

- 解析 `.all` 文件头部信息（站号、线路号、时间、GPS 标志、启动类型等）；
- 解析三相波形数据（A/B/C，相量单位保持与原装置一致）；
- 在波形上自动识别单端测距所需的入射波 / 反射波波头；
- 使用简化的行波测距数学公式，给出距测量端的故障距离。

## 数学模型

### 1. 双端行波测距（当前代码中作为算法模块保留，便于后续扩展）

双端行波测距的简化模型如下：

$$
d = \dfrac{L + v \cdot (t_A - t_B)}{2}
$$

其中：

- \( L \)：线路全长；
- \( v \)：行波传播速度；
- \( d \)：故障点到 A 端的距离；
- \( t_A = \dfrac{d}{v} \)：故障行波从故障点传播到 A 端的走时；
- \( t_B = \dfrac{L - d}{v} \)：故障行波从故障点传播到 B 端的走时。

在 Java 代码中，对应 `FaultLocationAlgorithms.doubleEndByTimes(...)`，当前 Demo
尚未接上真实“双端 .all 文件配对”的流程，但算法已经单独封装好，后续可直接复用。

### 2. 单端行波测距（当前 Demo 实际运行的算法）

当只有一端录波数据时，可利用“入射波 + 反射波”的简化模型进行单端行波测距：

设：

- \( t_1 \)：故障行波入射波到达测量端的时间；
- \( t_2 \)：对应反射波（由远端或故障点反射）到达测量端的时间；
- \( v \)：行波传播速度。

则单端测距的简化公式为：

$$
d \approx \dfrac{v \cdot (t_2 - t_1)}{2}
$$

其中：

- \( d \)：故障点到该测量端的距离；
- 本公式假定线路均匀、反射路径为一次“往返”，适合作为教学 / Demo 使用，
  工程场景下需要结合实际线路模型做修正和校核。

在 Java 代码中，对应 `FaultLocationAlgorithms.singleEndByTwoWaveTimes(...)`。

## 代码结构概览

- `AllFileDecoder`：负责按给定的 C 参考实现逐字节解析 `.all` 文件：
  - 解析头部文本（16 个空格分隔）得到站号、线路号、时间、GPS 频率 / 标志、启动信息等；
  - 判断数据区长度，选择 12bit / 16bit 两种编码方式解析三相波形，生成 `CurrentData`。
- `CurrentData`：承载一次 `.all` 文件解析后的全部信息（头部字段 + 三相波形数组）。
- `FaultLocationAlgorithms`：封装单端 / 双端行波测距的数学公式，与文件格式解耦。
- `WaveformFaultAnalyzer`：在某一相波形（A/B/C）上自动识别波头，并调用单端测距公式：
  - 利用前若干采样点估计噪声；
  - 通过差分 + 阈值方式寻找**入射波**和**反射波**波头；
  - 将采样点索引转换为时间，再代入单端公式得到距离。
- `Main`：程序入口：
  - 在代码中写死一个 `.all` 文件名（位于 `src/data` 下）；
  - 解析并打印该文件的头部信息和前若干个 A 相采样值；
  - 在控制台询问用户选择测距相别（A/B/C），然后对选定相别执行单端测距；
  - 打印详细结果以及一行“最终故障点位置（相对本端）”摘要。

## 运行方式（Windows / PowerShell）

在项目根目录（包含 `src` 目录）下：

```powershell
cd d:\FaultLocation_demo

# 编译所有 Java 源文件
javac src\*.java

# 运行 Main（使用 Main.java 中指定的 .all 文件名）
java -cp src Main
```

运行过程中，控制台会依次输出：

1. 选定 `.all` 文件的基本信息：站号、线路号、时间、数据点数、GPS 信息、前若干个 A 相数据；
2. 提示你输入测距相别（A/B/C，直接回车则默认使用 A 相）；
3. 打印单端测距分析结果，包括：
   - 采用的测距相别；
   - 入射波 / 反射波的样本索引与时间；
   - 距测量端的故障距离；
   - 假定的行波速度、采样间隔和线路长度；
4. 最后一行给出：

```text
最终故障点位置（相对本端）= X.XXXXXX km
```

你可以通过修改 `Main` 中的 `TARGET_FILE_NAME`，来指定不同的 `.all` 文件进行解析与测距。

# 电网拓扑 + SQLite + 双端行波测距 Demo（可运行）

## 仅供个人练习，目前只有Java实现

- 一个很小的电网拓扑：3 个站（A/B/C），2 条线路（A-B、B-C）
- SQLite 数据库（`demo.db`）里保存：
  - 站名（`station`）
  - 线路号与长度、两端站点（`line`）
  - 双端到达时间与波速（`measurement`）
- 一个简化的双端行波测距定位计算：

$$
d = \dfrac{L + v \cdot (t_A - t_B)}{2}
$$

其中：
- $t_A = \dfrac{d}{v}$
- $t_B = \dfrac{L - d}{v}$

## 运行方式（Windows / PowerShell）



## 可用命令

```powershell
.\run.ps1 init
.\run.ps1 seed
.\run.ps1 simulate
.\run.ps1 locate
```

- `demo`：初始化 + 种子拓扑 + 插入一条样例测距 + 输出定位结果
- `simulate`：只插入一条样例测距记录（演示噪声）
- `locate`：对最新一条测距记录做定位并打印

## 运行结果
<img width="1477" height="750" alt="image" src="https://github.com/user-attachments/assets/d1c8a703-0aad-4a09-81c2-686c8667d8b2" />


